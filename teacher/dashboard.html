<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ******* CSS ******* -->
    <link rel="stylesheet" href="dashboard.css" />
    <!-- ******* ICONS ******* -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css"/>
    
    <!-- Include Shared Database System -->
    <script src="../database.js"></script>
    
    <!-- Additional Styles for Database Integration -->
    <style>
      .loading-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #666;
        grid-column: 1 / -1;
      }
      
      .loading-placeholder i {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #4CAF50;
      }
      
      .no-students, .error-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
        color: #666;
        grid-column: 1 / -1;
        background: #f9f9f9;
        border-radius: 10px;
        border: 2px dashed #ddd;
      }
      
      .no-students i, .error-message i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #999;
      }
      
      .error-message i {
        color: #f44336;
      }
      
      .retry-btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      
      .retry-btn:hover {
        background: #45a049;
      }
      
      .student-info p {
        font-size: 0.85rem;
        margin: 0.25rem 0;
      }
    </style>
    
    <title>Teacher Dashboard - School Management System</title>
  </head>
  <body>
    <section class="main-dashboard">
      <div class="dashboard-content">
        <!-- ******* HEADER SECTION ******* -->
        <div class="header-section">
          <div class="logo">
            <i class='bx bxs-graduation'></i>
            <span>Teacher Dashboard</span>
          </div>

          <div class="nav-menu">
            <ul>
              <li><a href="../index.html">Home</a></li>
              <li><a class="active" href="dashboard.html">My Classroom</a></li>
              <li><a href="#">Lesson Plans</a></li>
              <li><a href="#">Student Reports</a></li>
              <li><a href="#">Resources</a></li>
            </ul>
          </div>

          <div class="user-profile">
            <i class='bx bx-user-circle'></i>
            <span id="teacherName">Loading...</span>
            <div class="dropdown">
              <i class='bx bx-chevron-down'></i>
              <div class="dropdown-content">
                <a href="#">My Profile</a>
                <a href="#">Class Settings</a>
                <a href="#">Help & Support</a>
                <a href="../index.html">Logout</a>
              </div>
            </div>
          </div>
        </div>

        <!-- ******* TEACHER OVERVIEW ******* -->
        <div class="teacher-overview">
          <div class="overview-header">
            <h1 id="welcomeMessage">Welcome Back, Teacher!</h1>
            <p id="classInfo">Loading class information...</p>
          </div>
          
          <div class="class-stats">
            <div class="stat-card present-children">
              <i class='bx bxs-group'></i>
              <div class="stat-info">
                <h3 id="presentCount">0/0</h3>
                <p>Children Present</p>
                <span class="trend up" id="absentInfo">Loading...</span>
              </div>
            </div>
            
            <div class="stat-card activities-planned">
              <i class='bx bxs-calendar-check'></i>
              <div class="stat-info">
                <h3>6</h3>
                <p>Activities Today</p>
                <span class="trend stable">On schedule</span>
              </div>
            </div>
            
            <div class="stat-card next-activity">
              <i class='bx bxs-time'></i>
              <div class="stat-info">
                <h3>10:30 AM</h3>
                <p>Next Activity</p>
                <span class="trend neutral">Art & Crafts</span>
              </div>
            </div>
            
            <div class="stat-card parent-messages">
              <i class='bx bxs-message-dots'></i>
              <div class="stat-info">
                <h3>3</h3>
                <p>New Messages</p>
                <span class="trend up">From parents</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ******* DAILY SCHEDULE ******* -->
        <div class="daily-schedule">
          <h2 class="section-title">Today's Schedule - Friday, November 1, 2025</h2>
          
          <div class="schedule-timeline">
            <div class="schedule-item completed">
              <div class="time-slot">8:00 AM</div>
              <div class="activity-info">
                <h4>Morning Circle Time</h4>
                <p>Welcome song, weather discussion, calendar time</p>
                <span class="status completed">Completed</span>
              </div>
            </div>
            
            <div class="schedule-item completed">
              <div class="time-slot">8:30 AM</div>
              <div class="activity-info">
                <h4>Free Play</h4>
                <p>Building blocks, puzzles, reading corner</p>
                <span class="status completed">Completed</span>
              </div>
            </div>
            
            <div class="schedule-item completed">
              <div class="time-slot">9:15 AM</div>
              <div class="activity-info">
                <h4>Snack Time</h4>
                <p>Healthy snacks and milk, table manners practice</p>
                <span class="status completed">Completed</span>
              </div>
            </div>
            
            <div class="schedule-item current">
              <div class="time-slot">10:00 AM</div>
              <div class="activity-info">
                <h4>Learning Activity - Colors & Shapes</h4>
                <p>Interactive shape sorting, color matching games</p>
                <span class="status current">In Progress</span>
              </div>
            </div>
            
            <div class="schedule-item upcoming">
              <div class="time-slot">10:30 AM</div>
              <div class="activity-info">
                <h4>Art & Crafts</h4>
                <p>Finger painting - Fall leaves theme</p>
                <span class="status upcoming">Next</span>
              </div>
            </div>
            
            <div class="schedule-item upcoming">
              <div class="time-slot">11:15 AM</div>
              <div class="activity-info">
                <h4>Outdoor Play</h4>
                <p>Playground time, nature walk</p>
                <span class="status upcoming">Upcoming</span>
              </div>
            </div>
            
            <div class="schedule-item upcoming">
              <div class="time-slot">12:00 PM</div>
              <div class="activity-info">
                <h4>Lunch Time</h4>
                <p>Meal supervision, social skills development</p>
                <span class="status upcoming">Upcoming</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ******* STUDENT QUICK VIEW ******* -->
        <div class="student-section">
          <h2 class="section-title">My Students - Quick View</h2>
          
          <div class="students-grid" id="studentsGrid">
            <div class="loading-placeholder">
              <i class='bx bx-loader-alt bx-spin'></i>
              <p>Loading students from database...</p>
            </div>
          </div>
          
          <div class="view-all-students">
            <button class="view-all-btn" id="viewAllBtn">View All Students (Loading...)</button>
          </div>
        </div>
        </div>

        <!-- ******* TEACHING TOOLS ******* -->
        <div class="teaching-tools">
          <h2 class="section-title">Teaching Tools & Resources</h2>
          
          <div class="tools-grid">
            <div class="tool-card">
              <i class='bx bxs-book-content'></i>
              <h3>Lesson Plans</h3>
              <p>Create and manage daily lesson plans</p>
              <button class="tool-btn">Open Planner</button>
            </div>
            
            <div class="tool-card">
              <i class='bx bxs-camera'></i>
              <h3>Photo Gallery</h3>
              <p>Capture and share classroom moments</p>
              <button class="tool-btn">Take Photo</button>
            </div>
            
            <div class="tool-card">
              <i class='bx bxs-note'></i>
              <h3>Daily Reports</h3>
              <p>Send updates to parents about their child</p>
              <button class="tool-btn">Write Report</button>
            </div>
            
            <div class="tool-card">
              <i class='bx bxs-message-square-dots'></i>
              <h3>Parent Communication</h3>
              <p>Message parents and respond to inquiries</p>
              <button class="tool-btn">Messages (3)</button>
            </div>
            
            <div class="tool-card">
              <i class='bx bxs-calendar-event'></i>
              <h3>Attendance</h3>
              <p>Track daily attendance and absences</p>
              <button class="tool-btn">Take Attendance</button>
            </div>
            
            <div class="tool-card">
              <i class='bx bxs-first-aid'></i>
              <h3>Incident Reports</h3>
              <p>Report any incidents or concerns</p>
              <button class="tool-btn">New Report</button>
            </div>
          </div>
        </div>

        <!-- ******* QUICK ACTIONS ******* -->
        <div class="quick-actions">
          <h2 class="section-title">Quick Actions</h2>
          <div class="actions-grid">
            <button class="quick-btn emergency">
              <i class='bx bxs-alarm'></i>
              <span>Emergency Alert</span>
            </button>
            <button class="quick-btn help">
              <i class='bx bxs-help-circle'></i>
              <span>Request Help</span>
            </button>
            <button class="quick-btn supply">
              <i class='bx bxs-package'></i>
              <span>Supply Request</span>
            </button>
            <button class="quick-btn break">
              <i class='bx bxs-coffee'></i>
              <span>Break Coverage</span>
            </button>
          </div>
        </div>

        <!-- ******* TEACHER FOOTER ******* -->
        <div class="teacher-footer">
          <div class="footer-info">
            <p>&copy; 2025 Bangu Preschool - Teacher Portal</p>
            <p>Rainbow Class | Room 102 | Capacity: 20 Students</p>
          </div>
          <div class="footer-actions">
            <button class="footer-btn">Help & Support</button>
            <button class="footer-btn">Class Settings</button>
            <button class="footer-btn">Resource Library</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ******* JAVASCRIPT ******* -->
    <script>
      // Global variables
      let currentTeacher = null;
      let teacherStudents = [];
      
      // Teacher dashboard functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize database-driven dashboard
        initializeTeacherDashboard();
        
        // Dropdown functionality
        const dropdown = document.querySelector('.dropdown');
        const dropdownContent = document.querySelector('.dropdown-content');
        
        dropdown.addEventListener('click', function() {
          dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target)) {
            dropdownContent.style.display = 'none';
          }
        });

        // Tool buttons
        const toolBtns = document.querySelectorAll('.tool-btn');
        toolBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            const toolName = this.closest('.tool-card').querySelector('h3').textContent;
            alert(`Opening ${toolName} tool...`);
          });
        });

        // Quick action buttons
        const quickBtns = document.querySelectorAll('.quick-btn');
        quickBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            const action = this.querySelector('span').textContent;
            if (action === 'Emergency Alert') {
              if (confirm('Are you sure you want to send an emergency alert?')) {
                alert('Emergency alert sent to administration!');
              }
            } else {
              alert(`Executing: ${action}`);
            }
          });
        });

        // Schedule item interactions
        const scheduleItems = document.querySelectorAll('.schedule-item');
        scheduleItems.forEach(item => {
          item.addEventListener('click', function() {
            if (this.classList.contains('upcoming')) {
              const activity = this.querySelector('h4').textContent;
              if (confirm(`Mark "${activity}" as completed?`)) {
                this.classList.remove('upcoming');
                this.classList.add('completed');
                this.querySelector('.status').textContent = 'Completed';
                this.querySelector('.status').className = 'status completed';
              }
            }
          });
        });

        // Animation for stats cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, index * 100);
        });

        // Live time update for current activity
        function updateCurrentTime() {
          const now = new Date();
          const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
          });
          
          const currentTimeElements = document.querySelectorAll('.current .time-slot');
          currentTimeElements.forEach(element => {
            if (element.textContent.includes('10:00 AM')) {
              // Update with current progress indication
            }
          });
        }

        // Update time every minute
        setInterval(updateCurrentTime, 60000);
        updateCurrentTime();
      });

      // Initialize database-driven teacher dashboard
      function initializeTeacherDashboard() {
        // Check if database is available
        if (typeof window.db === 'undefined') {
          console.error('Database not loaded');
          showErrorMessage('Database connection failed. Please refresh the page.');
          return;
        }

        // Load teacher information (for demo, we'll use the first teacher)
        loadTeacherInfo();
        
        // Load students for this teacher's class
        loadTeacherStudents();
      }

      // Load teacher information from database
      function loadTeacherInfo() {
        try {
          const teachers = window.db.getCollection('teachers');
          const teacherArray = Object.values(teachers);
          
          if (teacherArray.length > 0) {
            // For demo, use the first teacher, but in real app this would be based on login
            currentTeacher = teacherArray[0];
            
            // Update UI with teacher info
            document.getElementById('teacherName').textContent = `${currentTeacher.firstName} ${currentTeacher.lastName}`;
            document.getElementById('welcomeMessage').textContent = `Welcome Back, ${currentTeacher.firstName}!`;
            document.getElementById('classInfo').textContent = `Class ${currentTeacher.assignedClass} | ID: ${currentTeacher.employeeId} | Position: ${currentTeacher.position}`;
            
            console.log('Teacher loaded:', currentTeacher);
          } else {
            showErrorMessage('No teacher data found. Please register teachers first.');
          }
        } catch (error) {
          console.error('Error loading teacher info:', error);
          showErrorMessage('Error loading teacher information.');
        }
      }

      // Load students for the teacher's class
      function loadTeacherStudents() {
        try {
          const students = window.db.getCollection('students');
          const studentArray = Object.values(students);
          
          if (currentTeacher && currentTeacher.assignedClass) {
            // Filter students by teacher's assigned class
            teacherStudents = studentArray.filter(student => 
              student.grade === currentTeacher.assignedClass
            );
            
            // Update UI with student information
            updateStudentStats();
            displayStudents();
            
            console.log('Students loaded for class:', currentTeacher.assignedClass, teacherStudents);
          } else {
            showErrorMessage('Teacher class assignment not found.');
          }
        } catch (error) {
          console.error('Error loading students:', error);
          showErrorMessage('Error loading student information.');
        }
      }

      // Update student statistics
      function updateStudentStats() {
        const totalStudents = teacherStudents.length;
        const presentStudents = Math.floor(totalStudents * 0.9); // Simulate 90% attendance
        const absentStudents = totalStudents - presentStudents;
        
        document.getElementById('presentCount').textContent = `${presentStudents}/${totalStudents}`;
        document.getElementById('absentInfo').textContent = `${absentStudents} absent today`;
        document.getElementById('viewAllBtn').textContent = `View All Students (${totalStudents})`;
      }

      // Display students in the grid
      function displayStudents() {
        const studentsGrid = document.getElementById('studentsGrid');
        
        if (teacherStudents.length === 0) {
          studentsGrid.innerHTML = `
            <div class="no-students">
              <i class='bx bx-user-plus'></i>
              <p>No students registered for this class yet.</p>
              <p>Students will appear here once they are registered through the super admin.</p>
            </div>
          `;
          return;
        }

        // Show first 6 students for quick view
        const studentsToShow = teacherStudents.slice(0, 6);
        
        studentsGrid.innerHTML = studentsToShow.map((student, index) => {
          const isPresent = Math.random() > 0.1; // 90% chance of being present
          const statusClass = isPresent ? 'present' : 'absent';
          const statusText = isPresent ? 'Present' : 'Absent';
          const arrivalTime = isPresent ? generateRandomArrivalTime() : 'N/A';
          
          return `
            <div class="student-card ${statusClass}">
              <img src="../assets/child${(index % 6) + 1}.jpg" alt="${student.firstName} ${student.lastName}" 
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmOGY5ZmEiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSIxOCIgeT0iMTgiPgo8cGF0aCBkPSJNMTIgMTJDMTQuNDg1MyAxMiAxNi41IDkuOTg1MjggMTYuNSA3LjVDMTYuNSA1LjAxNDcyIDE0LjQ4NTMgMyAxMiAzQzkuNTE0NzIgMyA3LjUgNS4wMTQ3MiA3LjUgNy41QzcuNSA5Ljk4NTI4IDkuNTE0NzIgMTIgMTIgMTJaIiBmaWxsPSIjMjc5ZjYwIi8+CjxwYXRoIGQ9Ik0xMiAxNEM4LjY4NjI5IDE0IDYgMTYuNjg2MyA2IDIwSDEyQzE1LjMxMzcgMjAgMTggMTYuNjg2MyAxOCAxNEgxMloiIGZpbGw9IiMyN2FlNjAiLz4KPC9zdmc+Cjwvc3ZnPgo='" 
                   class="student-photo">
              <div class="student-info">
                <h4>${student.firstName} ${student.lastName}</h4>
                <p>ID: ${student.studentId} | ${isPresent ? 'Arrival: ' + arrivalTime : 'Reason: ' + (Math.random() > 0.5 ? 'Sick' : 'Family')}</p>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
              <div class="student-actions">
                <button class="action-btn" onclick="openStudentNotes('${student.studentId}')"><i class='bx bx-note'></i></button>
                <button class="action-btn ${!isPresent ? 'disabled' : ''}" onclick="takeStudentPhoto('${student.studentId}')"><i class='bx bx-camera'></i></button>
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners to new buttons
        addStudentActionListeners();
      }

      // Generate random arrival time for simulation
      function generateRandomArrivalTime() {
        const times = ['7:45 AM', '8:00 AM', '8:15 AM', '8:30 AM', '8:45 AM'];
        return times[Math.floor(Math.random() * times.length)];
      }

      // Add event listeners to student action buttons
      function addStudentActionListeners() {
        // View all students button
        const viewAllBtn = document.getElementById('viewAllBtn');
        if (viewAllBtn) {
          viewAllBtn.onclick = function() {
            showAllStudents();
          };
        }
      }

      // Open student notes
      function openStudentNotes(studentId) {
        const student = teacherStudents.find(s => s.studentId === studentId);
        if (student) {
          alert(`Opening notes for ${student.firstName} ${student.lastName} (${student.studentId})...`);
        }
      }

      // Take student photo
      function takeStudentPhoto(studentId) {
        const student = teacherStudents.find(s => s.studentId === studentId);
        if (student) {
          alert(`Taking photo of ${student.firstName} ${student.lastName} (${student.studentId})...`);
        }
      }

      // Show all students
      function showAllStudents() {
        alert(`Viewing all ${teacherStudents.length} students in ${currentTeacher ? currentTeacher.assignedClass : 'this class'}...`);
      }

      // Show error message
      function showErrorMessage(message) {
        const studentsGrid = document.getElementById('studentsGrid');
        if (studentsGrid) {
          studentsGrid.innerHTML = `
            <div class="error-message">
              <i class='bx bx-error-circle'></i>
              <p>${message}</p>
              <button onclick="location.reload()" class="retry-btn">Retry</button>
            </div>
          `;
        }
        
        // Also update other elements
        document.getElementById('teacherName').textContent = 'Error Loading';
        document.getElementById('welcomeMessage').textContent = 'Error Loading Teacher Data';
        document.getElementById('classInfo').textContent = message;
      }
    </script>
  </body>
</html>
