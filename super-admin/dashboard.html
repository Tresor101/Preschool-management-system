<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ******* CSS ******* -->
    <link rel="stylesheet" href="dashboard.css" />
    <!-- ******* ICONS ******* -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css"/>
    
    <!-- Enhanced School Management Database System -->
    <script src="../database.js"></script>
    <title>Super Admin Dashboard - Bangu Preschool</title>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- ******* ENHANCED MODERN SIDEBAR ******* -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <div class="logo-icon">
              <i class='bx bxs-crown'></i>
            </div>
            <div class="logo-text">
              <span class="logo-title">Super Admin</span>
              <span class="logo-subtitle">Management Portal</span>
            </div>
          </div>
          <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class='bx bx-menu'></i>
          </button>
        </div>
        
        <div class="sidebar-profile">
          <div class="profile-avatar">
            <i class='bx bxs-user-circle'></i>
          </div>
          <div class="profile-info">
            <span class="profile-name">Administrator</span>
            <span class="profile-role">System Admin</span>
          </div>
          <div class="profile-status">
            <div class="status-indicator online"></div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <span class="nav-section-title">Main Navigation</span>
            <ul class="nav-list">
              <li class="nav-item">
                <a href="dashboard.html" class="nav-link active">
                  <div class="nav-icon">
                    <i class='bx bxs-dashboard'></i>
                  </div>
                  <span class="nav-text">Overview</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="user-registration.html" class="nav-link">
                  <div class="nav-icon">
                    <i class='bx bx-user-plus'></i>
                  </div>
                  <span class="nav-text">User Registration</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="user-directory.html" class="nav-link">
                  <div class="nav-icon">
                    <i class='bx bx-group'></i>
                  </div>
                  <span class="nav-text">User Directory</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="school-applications.html" class="nav-link">
                  <div class="nav-icon">
                    <i class='bx bx-file-blank'></i>
                  </div>
                  <span class="nav-text">School Applications</span>
                  <div class="nav-badge pending-count">0</div>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="student-reports.html" class="nav-link">
                  <div class="nav-icon">
                    <i class='bx bxs-report'></i>
                  </div>
                  <span class="nav-text">Student Reports</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="../teacher/student-assessments.html" class="nav-link" target="_blank">
                  <div class="nav-icon">
                    <i class='bx bx-chalkboard'></i>
                  </div>
                  <span class="nav-text">Teacher Access</span>
                  <div class="nav-badge">NEW</div>
                  <div class="nav-indicator"></div>
                </a>
              </li>
            </ul>
          </div>

          <div class="nav-section">
            <span class="nav-section-title">System Management</span>
            <ul class="nav-list">
              <li class="nav-item">
                <a href="system-logs.html" class="nav-link">
                  <div class="nav-icon">
                    <i class='bx bxs-file-doc'></i>
                  </div>
                  <span class="nav-text">System Logs</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
            </ul>
          </div>

          <div class="nav-section">
            <span class="nav-section-title">Quick Actions</span>
            <ul class="nav-list">
              <li class="nav-item">
                <a href="#" class="nav-link" onclick="exportAllData()">
                  <div class="nav-icon">
                    <i class='bx bx-download'></i>
                  </div>
                  <span class="nav-text">Export Data</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
              <li class="nav-item">
                <a href="../index.html" class="nav-link logout-link">
                  <div class="nav-icon">
                    <i class='bx bx-home'></i>
                  </div>
                  <span class="nav-text">Back to Home</span>
                  <div class="nav-indicator"></div>
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="system-status">
            <div class="status-item">
              <i class='bx bx-wifi'></i>
              <span>Online</span>
            </div>
            <div class="status-item">
              <i class='bx bx-time'></i>
              <span id="currentTime">--:--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ******* MAIN CONTENT ******* -->
      <div class="main-content">
        <div class="content-header">
          <h1>Dashboard Overview</h1>
          <div class="user-info">
            <span>Welcome, Super Admin</span>
            <i class='bx bxs-user-circle'></i>
          </div>
        </div>

        <!-- ******* CONTENT SECTIONS ******* -->
        <div class="content-sections">
          
          <!-- ******* OVERVIEW SECTION ******* -->
          <div class="content-section active" id="overview-section">
            <h2>System Overview</h2>
            
            <!-- ******* STATS OVERVIEW ******* -->
            <div class="stats-grid">
              <div class="stat-card success">
                <div class="stat-icon">
                  <i class='bx bxs-graduation'></i>
                </div>
                <div class="stat-content">
                  <h3>Total Students</h3>
                  <p class="stat-number" id="dbStudentCount">0</p>
                  <small>Registered</small>
                </div>
              </div>

              <div class="stat-card info">
                <div class="stat-icon">
                  <i class='bx bxs-briefcase'></i>
                </div>
                <div class="stat-content">
                  <h3>Staff Members</h3>
                  <p class="stat-number" id="dbStaffCount">0</p>
                  <small>Active</small>
                </div>
              </div>

              <div class="stat-card warning">
                <div class="stat-icon">
                  <i class='bx bxs-user-badge'></i>
                </div>
                <div class="stat-content">
                  <h3>Administrators</h3>
                  <p class="stat-number" id="dbAdminCount">0</p>
                  <small>System</small>
                </div>
              </div>

              <div class="stat-card primary">
                <div class="stat-icon">
                  <i class='bx bx-file-blank'></i>
                </div>
                <div class="stat-content">
                  <h3>Applications</h3>
                  <p class="stat-number" id="dbApplicationCount">0</p>
                  <small>Pending Review</small>
                </div>
              </div>

              <div class="stat-card critical">
                <div class="stat-icon">
                  <i class='bx bxs-data'></i>
                </div>
                <div class="stat-content">
                  <h3>Database Size</h3>
                  <p class="stat-number" id="databaseSize">0 KB</p>
                  <small id="databaseStatus">Local Storage</small>
                </div>
              </div>
            </div>

            <!-- ******* LOCAL DATABASE STATUS SECTION ******* -->
            <div class="debug-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
              <h4 style="margin: 0 0 10px 0; color: #4CAF50;">üóÑÔ∏è Local Database Status</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="updateDatabaseStatus()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Refresh Status
                </button>
                <button onclick="viewDatabaseStats()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  View Database Stats
                </button>
                <button onclick="resetDatabaseWithSTU()" style="padding: 8px 16px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Reset to STU Format
                </button>
                <button onclick="exportAllData()" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Export Data
                </button>
                <span style="padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                  Status: <span id="localDbStatus" style="color: #4CAF50;">‚úÖ Ready</span>
                </span>
              </div>
              <div style="margin-top: 10px; font-size: 12px; color: #666;">
                Last updated: <span id="lastUpdated">Loading...</span> | 
                <span style="color: #9C27B0;">Student ID Format: STU#### (4 digits)</span>
              </div>
            </div>

            <!-- ******* RECENT ACTIVITY SUMMARY ******* -->
            <div class="activity-summary">
              <h3>Recent System Activity</h3>
              <div class="activity-preview" id="recentActivityPreview">
                <p>Loading recent activity...</p>
              </div>
              <button class="btn-secondary" onclick="window.location.href='system-logs.html'">View All Logs</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript for Dashboard -->
    <script>
      // Enhanced database management functions (Database-Driven)
      function updateDatabaseStatus() {
        const statusEl = document.getElementById('localDbStatus');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        
        if (statusEl && typeof window.db !== 'undefined') {
          const stats = window.db.getStatistics();
          statusEl.textContent = `‚úÖ Ready (${stats.totalStudents + stats.totalTeachers + stats.totalAdmins + stats.totalApplications} records)`;
          statusEl.style.color = '#4CAF50';
        }
        
        if (lastUpdatedEl) {
          lastUpdatedEl.textContent = new Date().toLocaleString();
        }
        
        updateUserStats();
        updateOverviewDatabaseSize();
      }

      function viewDatabaseStats() {
        if (typeof window.db !== 'undefined') {
          const stats = window.db.getStatistics();
          
          let message = `üìä School Management Database Statistics\n\n`;
          message += `üë• Teachers: ${stats.totalTeachers} (Active: ${stats.activeTeachers})\n`;
          message += `üèõÔ∏è Admins: ${stats.totalAdmins}\n`;
          message += `üë∂ Students: ${stats.totalStudents} (Enrolled: ${stats.enrolledStudents})\n`;
          message += `üìù Applications: ${stats.totalApplications} (Pending: ${stats.pendingApplications})\n`;
          message += `üè´ Classes: ${stats.totalClasses}\n\n`;
          message += `üìö Class Structure:\n`;
          message += `- Grade 1: A, B, C\n`;
          message += `- Grade 2: A, B, C\n`;
          message += `- Grade 3: A, B, C\n\n`;
          message += `üîê Authentication:\n`;
          message += `- Teachers: Username = Employee ID, Password = teacher123\n`;
          message += `- Admins: Username = Employee ID, Password = admin123\n\n`;
          message += `üìã Student ID Format: STU#### (e.g., STU0001, STU0002)\n`;
          message += `üìÖ Last Updated: ${new Date().toLocaleString()}`;
          
          alert(message);
        } else {
          alert('‚ùå Database not initialized');
        }
      }

      // Reset database with STU format
      function resetDatabaseWithSTU() {
        if (!confirm('‚ö†Ô∏è This will reset all data and generate fresh data with STU#### student ID format.\n\nThis action cannot be undone. Continue?')) {
          return;
        }
        
        if (typeof window.db !== 'undefined') {
          try {
            // Clear and reinitialize database
            window.db.initializeFreshData();
            
            // Update dashboard
            updateDatabaseStatus();
            
            alert('‚úÖ Database reset complete!\n\nüìä New Structure:\n‚Ä¢ 9 Classes (Grade 1A-3C)\n‚Ä¢ 9 Teachers (1 per class)\n‚Ä¢ 2 Administrators (Principal & Vice Principal)\n‚Ä¢ Students with STU0001+ format\n‚Ä¢ Pending applications\n\nüîê Login Credentials:\n‚Ä¢ Teachers: Username = Employee ID, Password = teacher123\n‚Ä¢ Admins: Username = Employee ID, Password = admin123');
          } catch (error) {
            console.error('Reset failed:', error);
            alert('‚ùå Reset failed: ' + error.message);
          }
        } else {
          alert('‚ùå Database not available for reset');
        }
      }

      function exportAllData() {
        if (typeof window.db !== 'undefined') {
          try {
            const data = window.db.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `school_database_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('üì• Data exported successfully!');
          } catch (error) {
            console.error('Export failed:', error);
            alert('‚ùå Export failed: ' + error.message);
          }
        }
      }

      // Update statistics
      function updateUserStats() {
        if (typeof window.db !== 'undefined') {
          const stats = window.db.getStatistics();
          
          // Update individual counts from database-driven statistics
          const studentCountEl = document.getElementById('dbStudentCount');
          const staffCountEl = document.getElementById('dbStaffCount');
          const adminCountEl = document.getElementById('dbAdminCount');
          const applicationCountEl = document.getElementById('dbApplicationCount');
          
          if (studentCountEl) {
            studentCountEl.textContent = stats.totalStudents;
            studentCountEl.title = `Enrolled: ${stats.enrolledStudents}, Total Classes: ${stats.totalClasses}`;
          }
          
          if (staffCountEl) {
            staffCountEl.textContent = stats.totalTeachers;
            staffCountEl.title = `Active Teachers: ${stats.activeTeachers}`;
          }
          
          if (adminCountEl) {
            adminCountEl.textContent = stats.totalAdmins;
            adminCountEl.title = `Principal, Vice Principal and Administrative Staff`;
          }
          
          if (applicationCountEl) {
            applicationCountEl.textContent = stats.totalApplications;
            applicationCountEl.title = `Pending: ${stats.pendingApplications}`;
      function updateOverviewDatabaseSize() {
        const sizeElement = document.getElementById('databaseSize');
        const statusElement = document.getElementById('databaseStatus');
        
        if (sizeElement && typeof window.db !== 'undefined') {
          const stats = window.db.getStatistics();
          const totalRecords = stats.totalStudents + stats.totalTeachers + stats.totalAdmins + stats.totalApplications;
          
          sizeElement.textContent = `${totalRecords} records`;
          
          if (statusElement) {
            statusElement.textContent = 'Active';
          }
        }
      }
            displaySize = storageUsed + ' B';
          } else if (storageUsed < 1024 * 1024) {
            displaySize = Math.round(storageUsed / 1024) + ' KB';
          } else {
            displaySize = Math.round(storageUsed / (1024 * 1024)) + ' MB';
          }
          
          sizeElement.textContent = displaySize;
          
          if (statusElement) {
            statusElement.textContent = `${stats.totalRecords} Records`;
          }
        }
      }

      function loadRecentActivity() {
        const activityEl = document.getElementById('recentActivityPreview');
        if (activityEl && typeof window.db !== 'undefined') {
          const recentActivities = window.db.getRecentActivities(3);
          
          if (recentActivities.length > 0) {
            let html = '';
            recentActivities.forEach(activity => {
              const date = new Date(activity.timestamp).toLocaleDateString();
              const time = new Date(activity.timestamp).toLocaleTimeString();
              
              let icon = 'üìù';
              if (activity.type === 'Application') icon = 'üìÑ';
              else if (activity.type === 'student') icon = 'üéì';
              else if (activity.type === 'staff') icon = 'üë®‚Äçüè´';
              else if (activity.type === 'admin') icon = 'üë®‚Äçüíº';
              
              html += `<div class="activity-item">${icon} ${activity.description} (${date} ${time})</div>`;
            });
            activityEl.innerHTML = html;
          } else {
            activityEl.innerHTML = `
              <div class="activity-item">üè´ System initialized with sample data</div>
              <div class="activity-item">üóÑÔ∏è Database active with ${window.db.getTotalRecords()} records</div>
              <div class="activity-item">‚úÖ All systems operational</div>
            `;
          }
        }
      }

      // Initialize dashboard with enhanced database-driven functionality
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ Dashboard loaded successfully!');

        // Wait for database to be ready
        setTimeout(() => {
          // Check if database is properly initialized
          if (typeof window.db !== 'undefined') {
            console.log('üóÑÔ∏è Database system loaded');
            
            // Verify STU format
            const students = window.db.getStudents();
            const studentIds = students.map(s => s.studentId);
            const hasStuFormat = studentIds.some(id => id.startsWith('STU'));
            
            if (hasStuFormat) {
              console.log('‚úÖ STU format detected in student IDs');
            } else if (studentIds.length > 0) {
              console.log('‚ö†Ô∏è Non-STU format detected, reset recommended');
            }
            
            // Initialize dashboard data
            updateUserStats();
            updateOverviewDatabaseSize();
            loadRecentActivity();
            updateDatabaseStatus();
            
            console.log('üìä Dashboard initialized with database-driven data');
            
            // Set up auto-refresh for real-time updates
            setInterval(() => {
              updateUserStats();
              loadRecentActivity();
              console.log('üîÑ Dashboard auto-refreshed with latest database data');
            }, 30000); // Refresh every 30 seconds
            
          } else {
            console.error('‚ùå Database system not available');
          }
        }, 500); // Initial delay to ensure database is ready

        console.log('‚úÖ Dashboard initialization complete - All data is database-driven');
      });

      // Enhanced Sidebar Functions
      function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('collapsed');
        
        // Save state to localStorage
        const isCollapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem('sidebarCollapsed', isCollapsed);
      }

      // Update current time
      function updateCurrentTime() {
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          const now = new Date();
          const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          timeElement.textContent = timeString;
        }
      }

      // Update pending applications count in sidebar
      function updatePendingCount() {
        if (typeof window.db !== 'undefined') {
          const pendingApplications = window.db.getApplicationsByStatus('pending');
          const badge = document.querySelector('.pending-count');
          if (badge) {
            const count = pendingApplications.length;
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
          }
        }
      }

      // Initialize sidebar state and functionality
      function initializeSidebar() {
        // Restore sidebar state
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed) {
          document.querySelector('.sidebar').classList.add('collapsed');
        }

        // Add tooltips for collapsed state
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          const text = link.querySelector('.nav-text')?.textContent;
          if (text) {
            link.setAttribute('data-tooltip', text);
          }
        });

        // Update time immediately and then every minute
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        // Update pending count
        updatePendingCount();
        setInterval(updatePendingCount, 30000);

        // Mobile sidebar handling
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector('.sidebar');
          const overlay = document.createElement('div');
          overlay.className = 'sidebar-overlay';
          document.body.appendChild(overlay);

          overlay.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
          });
        }

        console.log('üéØ Enhanced sidebar initialized');
      }

      // Initialize sidebar when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initializeSidebar();
      });
    </script>
  </body>
</html>
